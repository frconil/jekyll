---
title: Puppet, Debconf and Preseed, Part 2
tags: Puppet Debian Packaging
layout: post
---
The problem with automated installs is that sometimes you need to answer to some questions. Now you can have static preseed files that do that for you, but sometimes you want them to be not so static.

We have an issue where a specific package needs very specific things, one of them being access to a mysql server. And the root mysql password for said server. ("only" the root mysql password, mind you.)

Now we could just create a quick preseeded install for this, whack in a default password (which would be more or less secure) and go on our merry way, but it would be...regrettable if one of those (shared) credentials were to be compromised. More so if someone tries every host for ports responding to sql queries.

So you generate random mysql passwords but then you need to keep rack of them, maybe go on each machine and run the package manually.

Or you can have a non-static preseed file generated by puppet, that uses the same randomly generated password you used for the mysql install.

Your file would look like this:


{% highlight erb %}
# /modules/package/templates/package.preseed.erb

mypackage mypackage/db_root_pass     password  <%= package_mysqlrootpw %>
mypackage mypackage/myvariable       string    <%= package_myvariable %>
mypackage mypackage/myothervariable  string    <%= package_myothervariable %>
{% endhighlight %}

(Pro-Tip: You want it to match EXACTLY the format of your debconf-get-selections output, down to the space. Debconf will parse an extra space as an actual answer to any config question)

Then you can patch it back up in your module's init.pp


{% highlight puppet %}

# /modules/package/manifests/init.pp  

class package ($package_mysqlrootpw, $package_myvariable, $package_myothervariable)  
{
  import "mysql"
  include mysql::server  

  package {
    "package": ensure => present,
    responsefile => "/var/cache/debconf/package.preseed",
    require      => File["/var/cache/debconf/package.preseed"],
  }  

  file { "/var/cache/debconf/package.preseed":
    owner        => root,
    group        => root,
    mode         => 600,
    ensure       => present,
    content      => template("package/package.preseed.erb"),
  }

}


{% endhighlight %}


You can then generate a random password for this particular sql instance and include that in your deployment's pp file.

Obviously the mysql example was a bit extreme (and the package is in dire need of being refactored to not make such extravagant demands, and would you just let us do our job, and yes we will give you a database and a user with write access to said database and we don't see why you even need root access anyway thank you.), but it's actually quite useful to be able to install <package of choice> pre-configured with the specific variables we've already defined in the pp file.

